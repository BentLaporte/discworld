<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, November 22, 2021, 4:25 PM -->
<!-- MuClient version 5.06 -->

<!-- Plugin "BerserkStats" generated by Plugin Wizard -->

<muclient>
<plugin
   name="BerserkStats"
   author="Tetraam"
   id="90ae8026597de8eccfdf00a6"
   language="Lua"
   purpose="Berserk Stats and Helper"
   date_written="2021-11-22 16:25:14"
   requires="5.06"
   version="1.0"
   >
</plugin>

<!-- Triggers-->
<triggers>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   match="^.{0,}(Hp: ){1,3}([0-9]{1,4}).{0,}(Gp: ){1,3}([0-9]{1,4}).{0,}$"
   regexp="y"
   script="ParsePoints"
   sequence="35"
   name="CheckPoints"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   match="^.{0,}\| \| (tactics\.\.\.\.\.\.\.\.\.) {1,3}([0-9]{1,4}) {1,3}([0-9]{1,4}).{0,}$"
   regexp="y"
   script="ParseTactics"
   sequence="35"
   name="CheckTactics"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   match="You suddenly feel eight feet tall, bloodthirsty and more than slightly insane!"
   regexp="y"
   script="SetBerserkTimer"
   sequence="35"
   name="CheckBerserk"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   custom_colour="17"
   colour_change_type="1"
   other_text_colour="red"
   match="Your berserker rage departs you as suddenly as it came, leaving you spiritually and physically exhausted."
   regexp="y"
   script="PlaySoundExhaustion"
   sequence="35"
   name="CheckPhysical"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   custom_colour="17"
   colour_change_type="1"
   other_text_colour="red"
   match="You have recovered from the physical stress of berserking."
   regexp="y"
   sequence="35"
   name="CheckSpiritual"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   custom_colour="17"
   colour_change_type="1"
   other_text_colour="red"
   match="You have recovered the spiritual strength needed to berserk."
   regexp="y"
   script="Reset"
   sequence="35"
   name="CheckEnd"
  >
  </trigger>
  <trigger
   enabled="n"
   ignore_case="n"
   keep_evaluating="y"
   match="The berserker rage departs you suddenly, but you don't feel fatigued."
   regexp="y"
   script="Reset"
   sequence="35"
   name="CheckSoothe"
  >
  </trigger>
</triggers>  
  
<!-- Aliases -->
<aliases>
  <alias
   script="Berserk"
   match="berserk"
   enabled="y"
   sequence="40"
   ignore_case="y"
  >  
  </alias>
  <alias
   script="Help"
   match="berserk help"
   enabled="y"
   sequence="40"
   ignore_case="y"
  >
  </alias>
  <alias
   script="ShowOutput"
   match="berserk show"
   enabled="y"
   sequence="40"
   ignore_case="y"
  >
  </alias>
  <alias
   script="Reset"
   match="berserk reset"
   enabled="y"
   sequence="40"
   ignore_case="y"
  >
  </alias>
</aliases>

<!--  Timers  -->
<timers>
  <timer
   script="UpdateBerserk"
   name="BerserkTimer"
   enabled="n"
   second="1.00"
  >
  </timer>
</timers>
  
<script>
<![CDATA[
-- ********************************************************************
-- *****                Tetraam's Berserk Stat Functions          *****
-- ********************************************************************

-- *********************
-- * Global varbiables *
-- *********************

iMyHP = 0
iMyGP = 0
iMyTactics = 0
iBeginTime = 0
iRemainingTime = 0
iBerserk = 0
iPhysical = 85
iSpiritual = 240

-- ********************
-- * Helper functions *
-- ********************

function GetPoints ()
  EnableTrigger("CheckPoints", true)
  Send("score brief")
  
end

function GetTactics ()
  EnableTrigger("CheckTactics", true)
  Send("skills fi.sp.ta")
end

function GetDuration()
  if iMyGP > iMyTactics then
    iBerserk = iMyTactics
  else
    iBerserk = iMyGP
  end
end

function ParsePoints (sName, sLine, wildcards)
  EnableTrigger("CheckPoints", false)
  iMyHP = tonumber(wildcards[2])
  iMyGP = tonumber(wildcards[4])
end

function ParseTactics (sName, sLine, wildcards)
  EnableTrigger("CheckTactics", false)
  iMyTactics = tonumber(wildcards[3])
end

function SetVariables()
  GetPoints()
  GetTactics()
  DoAfterSpecial (0.2, 'GetDuration()', sendto.script)
end

function SetBerserkTimer()
  EnableTrigger("CheckBerserk", false)
  EnableTrigger("CheckPhysical", true)
  EnableTrigger("CheckSpiritual", true)
  EnableTrigger("CheckEnd", true)
  EnableTrigger("CheckSoothe", true)
  iBeginTime = os.time()
  EnableTimer("BerserkTimer", true)
  PlaySoundBerserk()
  DoAfterSpecial (0.2, 'ShowTime(iBerserk,"berserk")', sendto.script)
end

function UpdateBerserk()
  local iCurrentTime = os.time()
  iRemainingTime = iBeginTime + iBerserk - iCurrentTime
  if iRemainingTime == 240 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 180 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 120 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 60 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 30 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 20 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  elseif iRemainingTime == 10 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "berserk")', sendto.script)
  end
end

function UpdatePhysical()
  local iCurrentTime = os.time()
  iRemainingTime = iBeginTime + iPhysical - iCurrentTime
  if iRemainingTime == 240 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)
  elseif iRemainingTime == 180 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)
  elseif iRemainingTime == 120 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)
  elseif iRemainingTime == 60 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)
  elseif iRemainingTime == 30 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)
  elseif iRemainingTime == 10 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "physical exhaustion")', sendto.script)  
  end
end

function UpdateSpiritual()
  local iCurrentTime = os.time()
  iRemainingTime = iBeginTime + iSpiritual - iCurrentTime
  if iRemainingTime == 240 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime == 180 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime == 120 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime == 60 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime == 30 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime == 10 then
    DoAfterSpecial (0.2, 'ShowTime(iRemainingTime, "spiritual exhaustion")', sendto.script)
  elseif iRemainingTime < 0 then
    StopSpiritual()
  end
end

function StopSpiritual()
  EnableTrigger("CheckEnd", false)
  EnableTrigger("CheckSoothe", false)  
  EnableTimer("SpiritualTimer", false)
end

function Berserk()
  SetVariables()
  EnableTrigger("CheckBerserk", true)
  Send("berserk")
end

-- ******************
-- * Show Functions *
-- ******************

function ShowOutput()
  ColourNote ("orange", "", "At start of berserk your tactics bonus was: " .. tostring(iMyTactics) .. ".")
  ColourNote ("orange", "", "At start of berserk your HP was: " .. tostring(iMyHP) .. ".")
  ColourNote ("orange", "", "At start of berserk your GP was: " .. tostring(iMyGP) .. ".")
  ColourNote ("orange", "", "Berserk duration is: " .. tostring(iBerserk) .. " seconds.")
end

function ShowTime(time,text)
  ColourNote ("orange", "", "" .. tostring(time) .. " seconds remaining on " .. text .. ".")
end

function Help()
  ColourNote ("orange", "", "'berserk' you will attempt to enter the berserk state")
  ColourNote ("orange", "", "'berserk show' show the attributes on which the berserk duration was calculated")
  ColourNote ("orange", "", "'berserk reset' reset the plugin")
  ColourNote ("orange", "", "'berserk help' show this help file")
end

-- *******************
-- * Sound Functions *
-- *******************
iSoundVolume = 0

function PlaySoundBerserk()
  --PlaySound (1, "C:Diwscworld/tetraam_plugins/wavs/warcry_female.mp3", false, iSoundVolume, 0)
  PlaySound (1, "C:/Discworld/tetraam_plugins/wavs/warcry_male.wav", false, iSoundVolume, 0)
end

function PlaySoundExhaustion()
  PlaySound (2, "C:/Discworld/tetraam_plugins/wavs/heartbeat.wav", false, iSoundVolume, 0)
end

function PlaySoundRelief()
  --PlaySound (3, "C:/Discworld/tetraam_plugins/wavs/sigh_female.wav", false, iSoundVolume, 0)
  PlaySound (3, "C:/Discworld/tetraam_plugins/wavs/sigh_male.wav", false, iSoundVolume, 0)
end

-- *******************
-- * Reset Functions *
-- *******************

function Reset()
  EnableTrigger("CheckBerserk", false)
  EnableTrigger("CheckPhysical", false)
  EnableTrigger("CheckSpiritual", false)
  EnableTrigger("CheckEnd", false)
  EnableTrigger("CheckSoothe", false)
  EnableTimer("BerserkTimer", false)
  PlaySoundRelief()
  ColourNote ("orange", "", "Plugin was reset.")
end
]]>
</script>  
  
</muclient>
